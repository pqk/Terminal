_4_1

Public rdate, matchdate, headingdate1, tabdate, pw, filedir, sourcefile

Sub ZN_Master()
    Call ZN_Reserve
    Call ZN_Results
    Call ZN_10Day_Results
End Sub

Sub ZN_Reserve()
Application.ScreenUpdating = False

'Establish report date variables
rdate = Application.InputBox(prompt:="Please enter report date (YYYYMM format)", Type:=1)
    If rdate = "" Then Exit Sub
matchdate = DateSerial(CInt(Left(rdate, 4)), CInt(Mid(rdate, 5, 2)), CInt(1))
eomatchdate = CDate(WorksheetFunction.EoMonth(matchdate, 0)) 'must wrap numeric data value in cdate()
headingdate1 = CInt(Mid(rdate, 5, 2)) & "??"
tabdate = CInt(Left(rdate, 4))

pw = "aj"
filedir = "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles"
batfile = "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\ZN_filename.bat"

'Transform source datafile
    'Embed .bat for filename change >>take out ”N“x add month on end
      Shell batfile & " " & rdate
      Application.Wait (Now + TimeValue("0:00:03")) 'wait for batch file to complete execution
      
    'Convert datafile from xls to xlsx
    Workbooks.Open Password:=pw, Filename:=filedir & "\aj‰s?\?A?N?A?\‘a(?????n???j" & rdate & ".xls"

    ActiveWorkbook.SaveAs Filename:=filedir & "\aj‰s?\?A?N?A?\‘a(?????n???j" & rdate & ".xlsx", _
        FileFormat:=xlOpenXMLWorkbook
    ActiveWorkbook.Close
    
    'Delete xls version
    On Error Resume Next
        Kill filedir & "\aj‰s?\?A?N?A?\‘a(?????n???j" & rdate & ".xls"
    On Error GoTo 0
    
'Open source file
sourcefile = "aj‰s?\?A?N?A?\‘a(?????n???j" & rdate & ".xlsx"

Workbooks.Open Password:=pw, Filename:=filedir & "\" & sourcefile

'standardize header dates
Sheets("‰s?\?￠???U").Activate
    Cells.Replace what:="01??", Replacement:="1??", LookAt:=xlPart, _
        SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
    Cells.Replace what:="02??", Replacement:="2??", LookAt:=xlPart, _
        SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
    Cells.Replace what:="03??", Replacement:="3??", LookAt:=xlPart, _
        SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
        
'Locate new data record
Sheets("‰s?\?￠???U").Activate
ActiveWindow.Zoom = 70
Columns("B:C").Select
Selection.Find(what:="Cash-Out‡@", After:=ActiveCell, LookIn:=xlFormulas _
        , LookAt:=xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, _
        MatchCase:=False, MatchByte:=False, SearchFormat:=False).Activate
ActiveCell.Offset(0, 1).Range("A1:L1").Find(what:=headingdate1).Activate

'Copy & Paste Values
ActiveCell.Offset(25, 0).Range("A1:A3").Copy

Workbooks("Zennichi_GZ_data.xlsm").Sheets("Reserve").Activate
Columns("D:D").Find(what:=eomatchdate).Offset(0, 4).Range("A1").Select 'for PROD change to offset(0,4)   WARNING MUST CHANGE search date to EOM
With ActiveCell
    .PasteSpecial Paste:=xlPasteValues, Transpose:=True
    .PasteSpecial Paste:=xlPasteFormats, Transpose:=True
End With

Workbooks(sourcefile).Sheets("‰s?\?￠???U").Activate
ActiveCell.Offset(55, 0).Range("A1:A3").Copy

Workbooks("Zennichi_GZ_data.xlsm").Sheets("Reserve").Activate
Columns("D:D").Find(what:=eomatchdate).Offset(0, 1).Range("A1").Select 'for PROD change to offset(0,1) WARNING MUST CHANGE search date to EOM
With ActiveCell
    .PasteSpecial Paste:=xlPasteValues, Transpose:=True
    .PasteSpecial Paste:=xlPasteFormats, Transpose:=True
End With

End Sub

'<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Sub ZN_Results()
Application.ScreenUpdating = False

Dim headingdate2

headingdate2 = Format(WorksheetFunction.EoMonth(matchdate, 0), "m/dd/yyyy")

Workbooks(sourcefile).Worksheets("?U?×").Activate
ActiveWindow.Zoom = 80

'delete spaces in order to cut & paste one block of values
Columns("A:Q").Find(what:=headingdate2).EntireRow.Activate
ActiveCell.Offset(1, 0).Activate
Do Until ActiveCell.Value = 14 'consider alternative to using =14
    If IsEmpty(ActiveCell.Value) Then
        ActiveCell.EntireRow.Delete
    Else
        ActiveCell.Offset(1, 0).Activate
    End If
Loop

'Locate new data record and Copy & Paste Values
Columns("A:Q").Find(what:=headingdate2).Offset(1, 0).Range("A1:A16").Copy
   
Workbooks("Zennichi_GZ_data.xlsm").Sheets("Results").Activate
Rows("2:2").Find(what:=headingdate2).Offset(1, 0).Range("A1").Select 'for PROD change to offset(1,0)
ActiveCell.PasteSpecial Paste:=xlPasteValues

Workbooks(sourcefile).Close savechanges:=False

End Sub

'<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Sub ZN_10Day_Results()
Application.ScreenUpdating = False

Dim fy_mm As String, fy_mm_last As String

fy_mm = CInt(Right(rdate, 4))
fy_mm_last = fy_mm - 1

batfile = "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\ZN_filename1.bat"

'Transform source datafile
    'Embed .bat for filename change >>YYMMDD format to YYYYMM format
      Shell batfile & " " & rdate
      Application.Wait (Now + TimeValue("0:00:03")) 'wait for batch file to complete execution

    'Convert datafile from xls to xlsx
    Workbooks.Open Password:=pw, Filename:=filedir & "\" & rdate & "‰s?\?￠?A?N.xls"

    ActiveWorkbook.SaveAs Filename:=filedir & "\" & rdate & "‰s?\?￠?A?N.xlsx", _
        FileFormat:=xlOpenXMLWorkbook
    ActiveWorkbook.Close
    
    'Delete xls version
    On Error Resume Next
        Kill filedir & "\" & rdate & "‰s?\?￠?A?N.xls"
    On Error GoTo 0
    
'Open source file
sourcefile = rdate & "‰s?\?￠?A?N.xlsx"

Workbooks.Open Password:=pw, Filename:=filedir & "\" & sourcefile
ActiveWindow.Zoom = 70

'cut & paste results worksheet
Workbooks(sourcefile).Worksheets(fy_mm).Move Before:=Workbooks("Zennichi_GZ_data.xlsm").Worksheets(fy_mm_last)

End Sub

<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>
bat.file

>>>>>>>>>>>>ver1

@echo off

color 0A
mode con: cols=75 lines=20

echo %1> C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\rdate.txt
set /p rdate= < "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\rdate.txt"

del "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\rdate.txt"

echo %rdate%
echo.

set fyear=%rdate:~-6,4%
set filepath=C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles
set fnameold="aj過払実績と予測(月次報告）%fyear%年度.xls"
set fnamenew="aj過払実績と予測(月次報告）%rdate%.xls"


cd /d %filepath%

ren %fnameold% %fnamenew%


>>>>>>>>>>>>>ver2
@echo off

color 0A
mode con: cols=75 lines=20

cd /d "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles"

echo %1> C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\rdate.txt
set /p rdate= < "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\rdate.txt"

del "C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles\rdate.txt"

echo %rdate%
echo.

set FY_MM=%rdate:~-4,4%
set fnamepart=過払い実績.xls

ren %FY_MM%*%fnamepart% %rdate%%fnamepart%


<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>


_4_2

Option Explicit

Sub build_PTs()
Dim wks As Worksheet, data_source As Worksheet
Dim PTCache As PivotCache
Dim pt As PivotTable
Dim table_Name As String
Dim PRange As Range
Dim FinalRow As Long, finalcol As Long
Dim results_rng As Range
Dim Month As Integer
Dim cell As Range
Dim target_field As String, edited_name As String

'Application.ScreenUpdating = False

Set wks = Worksheets("analysis1")
Set data_source = Workbooks("Zennichi_GZ_data.xlsm").Sheets("SUMMARY_2")

For Each pt In wks.PivotTables
    pt.TableRange2.Clear
Next pt

FinalRow = data_source.Cells(Rows.Count, 1).End(xlUp).Row
finalcol = data_source.Cells(1, Columns.Count).End(xlToLeft).Column
Set PRange = data_source.Cells(1, 1).Resize(FinalRow, finalcol)
Set PTCache = ActiveWorkbook.PivotCaches.Add(SourceType:=xlDatabase, SourceData:=PRange)

table_Name = "ZN_PT1" 'CHANGE
Set pt = PTCache.CreatePivotTable(TableDestination:=wks.Range("B2"), TableName:=table_Name)

pt.AddFields , RowFields:="Mo", ColumnFields:="Yr"
pt.PivotFields("YR").ShowAllItems = True

'<<<<<<<<<<<<<<<<<<  ?J?|???????”  >>>>>>>>>>>>>>>>>>
target_field = "GZ?J?|???”"
edited_name = "?J?|???”"

With pt.PivotFields(target_field)
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

With pt
    .TableStyle2 = "PivotStylelight16"
    .ColumnGrand = False
    .RowGrand = False
End With

'Determine number of values in column field "YR"
Dim pvt_Itm As PivotItem
Dim pvt_Tbl As PivotTable
Dim test, i
Dim col_array() As Integer
Dim col_count As Integer
Dim col_start As Integer

Set pvt_Tbl = wks.PivotTables(table_Name)

For Each pvt_Itm In pvt_Tbl.PivotFields("YR").PivotItems
    test = test + 1
    ReDim Preserve col_array(1 To test)
        For i = test To test
            col_array(i) = pvt_Itm
        Next i
Next

col_count = UBound(col_array, 1)
col_start = col_array(LBound(col_array, 1))

MsgBox "col_count : " & col_count & vbNewLine & "col_start : " & col_start
'<><<<><<><

'Copy
wks.PivotTables(table_Name).DataBodyRange.Copy

Set results_rng = wks.Columns("p:p").EntireColumn
Month = wks.Rows("1:1").Find(what:="Month").Offset(0, 1).Value + 1

'Locate column in table section that matches first year of input data from PT and then Paste
edited_name = Right(edited_name, 4)
results_rng.Find(what:=edited_name).Offset(0, 1).Range("A1:H1").Select
Selection.Find(what:=col_start).Offset(1, 0).PasteSpecial Paste:=xlPasteValues

For Each cell In ActiveCell.Range(Cells(1, 1), Cells(12, col_count)) 'delete 0 values in range to avoid null values in line graph
    If cell.Value = 0 Then cell.Clear
Next

'<<<<<< ?a‰d???” >>>>>>
wks.Range("A1").Activate
pt.PivotFields(edited_name).Orientation = xlHidden

'rename variables
target_field = "???????”"
edited_name = "?a‰d???”"

With pt.PivotFields(target_field)
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

'Copy
wks.PivotTables(table_Name).DataBodyRange.Copy

'Locate column in table section that matches first year of input data from PT and then Paste
edited_name = Right(edited_name, 4)
results_rng.Find(what:=edited_name).Offset(0, 1).Range("A1:H1").Select
Selection.Find(what:=col_start).Offset(1, 0).PasteSpecial Paste:=xlPasteValues

For Each cell In ActiveCell.Range(Cells(1, 1), Cells(12, col_count)) 'delete 0 values in range to avoid null values in line graph
    If cell.Value = 0 Then cell.Clear
Next

'<<<<<< ?J?|/?a‰dRatio >>>>>>
If col_array(UBound(col_array, 1)) > wks.Range("Q2") Then
    col_count = col_count - (col_array(UBound(col_array, 1)) - wks.Range("Q2"))
End If

results_rng.Find(what:="?J?|/?a‰dRatio").Offset(Month - 2, col_count).Copy
results_rng.Find(what:="?J?|/?a‰dRatio").Offset(Month - 1, col_count).PasteSpecial Paste:=xlPasteFormulas

col_count = col_count + (col_array(UBound(col_array, 1)) - wks.Range("Q2"))

'<<<<<< ?????a?z>>>>>>
wks.Range("A1").Activate
pt.PivotFields(edited_name).Orientation = xlHidden

'rename variables
target_field = "?????a?z"
edited_name = " ?????a?z"

With pt
    .CalculatedFields.Add "temp", "='?????a?z' /1000000", True
    .PivotFields("temp").Orientation = xlDataField
End With

With pt.PivotFields("?‡?v / " & "temp")
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

edited_name = Right(edited_name, 4)

'Copy
wks.PivotTables(table_Name).DataBodyRange.Copy

'Paste
results_rng.Find(what:=edited_name).Offset(0, 1).Range("A1:H1").Select
Selection.Find(what:=col_start).Offset(1, 0).PasteSpecial Paste:=xlPasteValues

For Each cell In ActiveCell.Range(Cells(1, 1), Cells(12, col_count)) 'delete 0 values in range to avoid null values in line graph
    If cell.Value = 0 Then cell.Clear
Next

'<<<<<< ?O?O?a?z >>>>>>
wks.Range("A1").Activate

Dim pvt As PivotTable, pf As PivotField
Dim strSource As String, strformula As String

Set pvt = wks.PivotTables(table_Name)
For Each pf In pt.CalculatedFields
    strSource = pf.SourceName
    strformula = pf.Formula
    pf.Delete
Next pf

'rename variables
target_field = "?O?O?a?z)"
edited_name = " ?O?O?a?z"

With pt
    .CalculatedFields.Add "temp", "='?O?O?a?z' /1000000", True
    .PivotFields("temp").Orientation = xlDataField
End With

With pt.PivotFields("?‡?v / " & "temp")
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

edited_name = Right(edited_name, 4)

'Copy
wks.PivotTables(table_Name).DataBodyRange.Copy

'Paste
results_rng.Find(what:=edited_name).Offset(0, 1).Range("A1:H1").Select
Selection.Find(what:=col_start).Offset(1, 0).PasteSpecial Paste:=xlPasteValues

For Each cell In ActiveCell.Range(Cells(1, 1), Cells(12, col_count)) 'delete 0 values in range to avoid null values in line graph
    If cell.Value = 0 Then cell.Clear
Next


'<<<<<< ?u?u?c???a?z >>>>>>
wks.Range("A1").Activate

Set pvt = wks.PivotTables(table_Name)
For Each pf In pt.CalculatedFields
    strSource = pf.SourceName
    strformula = pf.Formula
    pf.Delete
Next pf

'rename variables
target_field = "?u?u?c???a?z"
edited_name = " ?u?u?c???a?z"

With pt
    .CalculatedFields.Add "temp", "='?u?u?c???a?z' /1000000", True
    .PivotFields("temp").Orientation = xlDataField
End With

With pt.PivotFields("?‡?v / " & "temp")
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

edited_name = Right(edited_name, 6)

'Copy
wks.PivotTables(table_Name).DataBodyRange.Copy

'Paste
results_rng.Find(what:=edited_name).Offset(0, 1).Range("A1:H1").Select
Selection.Find(what:=col_start).Offset(1, 0).PasteSpecial Paste:=xlPasteValues

For Each cell In ActiveCell.Range(Cells(1, 1), Cells(12, col_count)) 'delete 0 values in range to avoid null values in line graph
    If cell.Value = 0 Then cell.Clear
Next

'<<<<<< GZ???X >>>>>>
If col_array(UBound(col_array, 1)) > wks.Range("Q2") Then
    col_count = col_count - (col_array(UBound(col_array, 1)) - wks.Range("Q2"))
End If

results_rng.Find(what:="GZ???X").Offset(Month - 2, col_count).Copy
results_rng.Find(what:="GZ???X").Offset(Month - 1, col_count).PasteSpecial Paste:=xlPasteFormulas

'<<<<<< GZ???X’P‰? >>>>>>
results_rng.Find(what:="GZ???X’P‰?").Offset(Month - 2, col_count).Copy
results_rng.Find(what:="GZ???X’P‰?").Offset(Month - 1, col_count).PasteSpecial Paste:=xlPasteFormulas

'<<<<<< ?O?O?| >>>>>>
results_rng.Find(what:="?O?O?|").Offset(Month - 2, col_count).Copy
results_rng.Find(what:="?O?O?|").Offset(Month - 1, col_count).PasteSpecial Paste:=xlPasteFormulas

col_count = col_count + (col_array(UBound(col_array, 1)) - wks.Range("Q2"))

'<<<<<< ?Y?E >>>>>>
wks.Range("A1").Activate

Set pvt = wks.PivotTables(table_Name)
For Each pf In pt.CalculatedFields
    strSource = pf.SourceName
    strformula = pf.Formula
    pf.Delete
Next pf

'rename variables
target_field = "?Y?E"
edited_name = "?Y?E"

With pt.PivotFields(target_field)
    .Orientation = xlDataField
    .Function = xlSum
    '.Caption = edited_name
    .Position = 1
    .NumberFormat = "#,##"
End With

'Copy
wks.PivotTables(table_Name).DataBodyRange.Copy

'Paste
results_rng.Find(what:=edited_name).Offset(0, 1).Range("A1:H1").Select
Selection.Find(what:=col_start).Offset(1, 0).PasteSpecial Paste:=xlPasteValues

For Each cell In ActiveCell.Range(Cells(1, 1), Cells(12, col_count)) 'delete 0 values in range to avoid null values in line graph
    If cell.Value = 0 Then cell.Clear
Next

'wks.PivotTables(table_Name).DataBodyRange.Copy
'results_rng.Find(what:=edited_name).Offset(1, 1).PasteSpecial Paste:=xlPasteValues

'For Each cell In ActiveCell.Range("A1:H12")
'    If cell.Value = 0 Then cell.Clear
'Next

With ActiveSheet.Cells
    .RowHeight = 12.75
    .Font.Name = "calibri"
    .Cells.Font.Size = 10.5
End With

wks.Range("A1").Activate

MsgBox "データの処理を完了しました。"

End Sub




