_4_3

Public rdate, matchdate, headingdate1, tabdate, pw, filedir, sourcefile
Option Base 1

Sub ZN_Master()
    Call ZN_Reserve
    Call ZN_Results
    Call ZN_10Day_Results
    
    MsgBox "?f?[?^?I?????d?R?1?μ?U?μ???B"
    
End Sub

Sub ZN_Reserve()
Application.ScreenUpdating = False

'Assign Variables
rdate = Application.InputBox(prompt:="?n???I“u?t?d“u?I?μ?A‰o?3?￠?B (YYYYMM ?`?R)", Type:=1)
    If rdate = "" Then Exit Sub
matchdate = DateSerial(CInt(Left(rdate, 4)), CInt(Mid(rdate, 5, 2)), CInt(1))
eomatchdate = CDate(WorksheetFunction.EoMonth(matchdate, 0)) 'must wrap numeric data value in cdate()

If CInt(Mid(rdate, 5, 2)) = 1 Or CInt(Mid(rdate, 5, 2)) = 2 Or CInt(Mid(rdate, 5, 2)) = 3 Then
    headingdate1 = "0" & CInt(Mid(rdate, 5, 2)) & "??"
    Else: headingdate1 = CInt(Mid(rdate, 5, 2)) & "??"
End If

tabdate = CInt(Left(rdate, 4))
pw = "aj"
filedir = Application.InputBox(prompt:="?3?f?[?^?I?i”[?a?I?t?@?C???I?p?X?d‘S?A“u?I?μ?A‰o?3?￠?B")
'"C:\Users\400001946\Documents\GZ_MI\Zennichi\ZN_datafiles"

'Refresh Pivot_Tables reference dates
With Worksheets("analysis1")
    .Range("N1").Value = Int(Mid(rdate, 5, 2))
    .Range("N2").Value = tabdate
End With
     
'Open source file
sourcefile = "aj‰s?\?A?N?A?\‘a(?????n???j" & rdate & ".xlsx"

Workbooks.Open Password:=pw, Filename:=filedir & "\" & sourcefile

'Locate new data record
Sheets("‰s?\?￠???U").Activate
ActiveWindow.Zoom = 70
Columns("B:C").Select
Selection.Find(what:="Cash-Out‡@", After:=ActiveCell, LookIn:=xlFormulas _
        , LookAt:=xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, _
        MatchCase:=False, MatchByte:=False, SearchFormat:=False).Activate
ActiveCell.Offset(0, 1).Range("A1:L1").Find(what:=headingdate1).Activate

'Copy & Paste Values
ActiveCell.Offset(28, 0).Range("A1:A3").Copy 'automate offset() row

Workbooks("Zennichi_GZ_data.xlsm").Sheets("Reserve").Activate
Columns("D:D").Find(what:=eomatchdate).Offset(0, 4).Range("A1").Select
With ActiveCell
    .PasteSpecial Paste:=xlPasteValues, Transpose:=True
    .PasteSpecial Paste:=xlPasteFormats, Transpose:=True
    With .Resize(1, 3)
        .Borders.LineStyle = xlNone
        .Font.Name = "calibri"
        .Font.Size = 10.5
    End With
End With

Workbooks(sourcefile).Sheets("‰s?\?￠???U").Activate
ActiveCell.Offset(61, 0).Range("A1:A3").Copy 'automate offset() row

Workbooks("Zennichi_GZ_data.xlsm").Sheets("Reserve").Activate
Columns("D:D").Find(what:=eomatchdate).Offset(0, 1).Range("A1").Select
With ActiveCell
    .PasteSpecial Paste:=xlPasteValues, Transpose:=True
    .PasteSpecial Paste:=xlPasteFormats, Transpose:=True
    With .Resize(1, 3)
        .Borders.LineStyle = xlNone
        .Font.Name = "calibri"
        .Font.Size = 10.5
    End With
End With

End Sub

'<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Sub ZN_Results()
Application.ScreenUpdating = False

Dim headingdate2

headingdate2 = Format(WorksheetFunction.EoMonth(matchdate, 0), "m/dd/yyyy")

Workbooks(sourcefile).Worksheets("?U?×").Activate
ActiveWindow.Zoom = 80

'delete spaces in order to cut & paste one block of values
Columns("A:Q").Find(what:=headingdate2).EntireRow.Activate
ActiveCell.Offset(1, 0).Activate
Do Until ActiveCell.Value = 14
    If IsEmpty(ActiveCell.Value) Then
        ActiveCell.EntireRow.Delete
    Else
        ActiveCell.Offset(1, 0).Activate
    End If
Loop

'Locate new data record and Copy & Paste Values
Columns("A:Q").Find(what:=headingdate2).Offset(1, 0).Range("A1:A16").Copy
   
Workbooks("Zennichi_GZ_data.xlsm").Sheets("Results").Activate
Rows("2:2").Find(what:=headingdate2).Offset(1, 0).Range("A1").Select
ActiveCell.PasteSpecial Paste:=xlPasteValues

Workbooks(sourcefile).Close savechanges:=False

End Sub

'<<<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Sub ZN_10Day_Results()
Application.ScreenUpdating = False

Dim fy_mm As String, fy_mm_last As String, fy_mm_next As String

fy_mm = CInt(Right(rdate, 4))
If CInt(Mid(rdate, 5, 2)) = 1 Then
    fy_mm_last = (CInt(Mid(rdate, 3, 2)) - 1) & "12"
Else
    test1 = (CInt(Mid(rdate, 3, 2)) - 1) & "12" 'TEST
    fy_mm_last = fy_mm - 1
End If

If CInt(Mid(rdate, 5, 2)) = 12 Then
    fy_mm_next = (CInt(Mid(rdate, 3, 2)) + 1) & "01"
Else
    test2 = CInt(Mid(rdate, 3, 2)) & "01" 'TEST
    fy_mm_next = fy_mm + 1
End If
    
'Open source file
sourcefile = rdate & "‰s?\?￠?A?N.xlsx"

Workbooks.Open Password:=pw, Filename:=filedir & "\" & sourcefile
ActiveWindow.Zoom = 70

'cut & paste results worksheet
Workbooks(sourcefile).Worksheets(fy_mm).Move Before:=Workbooks("Zennichi_GZ_data.xlsm").Worksheets(fy_mm_last)

End Sub


_4_4
Option Explicit
Option Base 1

Sub ZN_PT()
Dim wks As Worksheet, data_source As Worksheet
Dim FinalRow As Long, finalcol As Long
Dim PTCache As PivotCache
Dim PRange As Range
Dim table_Name As String
Dim PT As PivotTable
Dim results_rng As Range
Dim Month As Integer
Dim target_field As String, edited_name As String
Dim PT_Array  As Variant 'zero values default to null when array is defined as variant
Dim pvt_Itm As PivotItem
Dim pvt_Tbl As PivotTable
Dim test, i, j
Dim col_array() As Integer
Dim col_count As Integer
Dim col_start As Integer

Dim pvt As PivotTable, pf As PivotField
Dim strSource As String, strformula As String


Application.ScreenUpdating = False

Set wks = Worksheets("analysis1") 'CHANGE
Set data_source = Workbooks("Zennichi_GZ_data.xlsm").Sheets("SUMMARY_2")
FinalRow = data_source.Cells(Rows.Count, 1).End(xlUp).Row
finalcol = data_source.Cells(1, Columns.Count).End(xlToLeft).Column
Set PRange = data_source.Cells(1, 1).Resize(FinalRow, finalcol)
Set PTCache = ActiveWorkbook.PivotCaches.Add(SourceType:=xlDatabase, SourceData:=PRange)

For Each PT In wks.PivotTables
    PT.TableRange2.Clear
Next PT

table_Name = "ZN_PT" 'CHANGE
Set PT = PTCache.CreatePivotTable(TableDestination:=wks.Range("B4"), TableName:=table_Name)
PT.AddFields , RowFields:="MO", ColumnFields:="Yr"
PT.PivotFields("YR").ShowAllItems = True

Set results_rng = wks.Columns("m:m").EntireColumn
Month = wks.Rows("1:1").Find(what:="Month").Offset(0, 1).Value

'<<<<<<<<<<<<<<<<<<  ?J?|???????”  >>>>>>>>>>>>>>>>>>
target_field = "GZ?J?|???”"
edited_name = "?J?|???”"

With PT.PivotFields(target_field)
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

With PT
    .TableStyle2 = "PivotStylelight16"
    .ColumnGrand = False
    .RowGrand = False
    .DisplayErrorString = True
End With


'<<<<< Determine number of values in column field "YR" >>>
Set pvt_Tbl = wks.PivotTables(table_Name)

For Each pvt_Itm In pvt_Tbl.PivotFields("YR").PivotItems
    test = test + 1
    ReDim Preserve col_array(1 To test)
        For i = test To test
            col_array(i) = pvt_Itm
        Next i
Next

col_count = UBound(col_array, 1)
col_start = col_array(LBound(col_array, 1))

'MsgBox "col_count : " & col_count & vbNewLine & "col_start : " & col_start
'<<<<<<<<<<<<<<<<<<<<>>>>>>>>>>>>>>>>>>>>>>>>>>>

' Assign PT values to array
PT_Array = wks.PivotTables(table_Name).DataBodyRange.Value

For j = LBound(PT_Array, 1) To UBound(PT_Array, 1)
    For i = LBound(PT_Array, 2) To UBound(PT_Array, 2)
        If PT_Array(j, i) = 0 Then
       PT_Array(j, i) = ""
        End If
    Next i
Next j

'Locate column in table section that matches first year of data from PT and then set equal to populated array from above
edited_name = Right(edited_name, 4)
results_rng.Find(what:=edited_name).Offset(1, 1).Resize(UBound(PT_Array, 1), UBound(PT_Array, 2)) = PT_Array


'<<<<<<<<<<<<<<<<<<  per biz day  >>>>>>>>>>>>>>>>>>
results_rng.Find(what:=edited_name).Offset(Month, col_count + 28).Copy
results_rng.Find(what:=edited_name).Offset(Month, col_count + 29).PasteSpecial Paste:=xlPasteFormulas


'<<<<<<<<<<<<<<<<<< ?a‰d???”  >>>>>>>>>>>>>>>>>>
wks.Range("A1").Activate
PT.PivotFields(edited_name).Orientation = xlHidden

target_field = "???????”"
edited_name = "?a‰d???”"

With PT.PivotFields(target_field)
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

' Assign PT values to array
PT_Array = wks.PivotTables(table_Name).DataBodyRange.Value

For j = LBound(PT_Array, 1) To UBound(PT_Array, 1)
    For i = LBound(PT_Array, 2) To UBound(PT_Array, 2)
        If PT_Array(j, i) = 0 Then
       PT_Array(j, i) = ""
        End If
    Next i
Next j

'Locate column in table section that matches first year of data from PT and then set equal to populated array from above
edited_name = Right(edited_name, 4)
results_rng.Find(what:=edited_name).Offset(1, 1).Resize(UBound(PT_Array, 1), UBound(PT_Array, 2)) = PT_Array


'<<<<<<<<<<<<<<<<<<  ?J?|/?a‰dRatio  >>>>>>>>>>>>>>>>>>
results_rng.Find(what:="?J?|/?a‰dRatio").Offset(Month, col_count - 1).Copy
results_rng.Find(what:="?J?|/?a‰dRatio").Offset(Month, col_count).PasteSpecial Paste:=xlPasteFormulas


'<<<<<<<<<<<<<<<<<<  ?????a?z  >>>>>>>>>>>>>>>>>>
wks.Range("A1").Activate
PT.PivotFields(edited_name).Orientation = xlHidden

target_field = "?????a?z"
edited_name = " ?????a?z"

With PT
    .CalculatedFields.Add "temp", "='?????a?z' /1000000", True
    .PivotFields("temp").Orientation = xlDataField
End With

With PT.PivotFields("?‡?v / " & "temp")
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

' Assign PT values to array
PT_Array = wks.PivotTables(table_Name).DataBodyRange.Value

For j = LBound(PT_Array, 1) To UBound(PT_Array, 1)
    For i = LBound(PT_Array, 2) To UBound(PT_Array, 2)
        If PT_Array(j, i) = 0 Then
       PT_Array(j, i) = ""
        End If
    Next i
Next j

'Locate column in table section that matches first year of data from PT and then set equal to populated array from above
edited_name = Right(edited_name, 4)
results_rng.Find(what:=edited_name).Offset(1, 1).Resize(UBound(PT_Array, 1), UBound(PT_Array, 2)) = PT_Array


'<<<<<<<<<<<<<<<<<<  ?O?O?a?z   >>>>>>>>>>>>>>>>>>
wks.Range("A1").Activate

Set pvt = wks.PivotTables(table_Name)
For Each pf In PT.CalculatedFields
    strSource = pf.SourceName
    strformula = pf.Formula
    pf.Delete
Next pf

target_field = "?O?O?a?z"
edited_name = " ?O?O?a?z"

With PT
    .CalculatedFields.Add "temp", "='?O?O?a?z' /1000000", True
    .PivotFields("temp").Orientation = xlDataField
End With

With PT.PivotFields("?‡?v / " & "temp")
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With


' Assign PT values to array
PT_Array = wks.PivotTables(table_Name).DataBodyRange.Value

For j = LBound(PT_Array, 1) To UBound(PT_Array, 1)
    For i = LBound(PT_Array, 2) To UBound(PT_Array, 2)
        If PT_Array(j, i) = 0 Then
       PT_Array(j, i) = ""
        End If
    Next i
Next j

'Locate column in table section that matches first year of data from PT and then set equal to populated array from above
edited_name = Right(edited_name, 4)
results_rng.Find(what:=edited_name).Offset(1, 1).Resize(UBound(PT_Array, 1), UBound(PT_Array, 2)) = PT_Array

'<<<<<<<<<<<<<<<<<<  ?u?u?c???a?z   >>>>>>>>>>>>>>>>>>
wks.Range("A1").Activate

Set pvt = wks.PivotTables(table_Name)
For Each pf In PT.CalculatedFields
    strSource = pf.SourceName
    strformula = pf.Formula
    pf.Delete
Next pf

target_field = "?u?u?c???a?z"
edited_name = " ?u?u?c???a?z"

With PT
    .CalculatedFields.Add "temp", "='?u?u?c???a?z' /1000000", True
    .PivotFields("temp").Orientation = xlDataField
End With

With PT.PivotFields("?‡?v / " & "temp")
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    .Caption = edited_name
    .NumberFormat = "#,##"
End With

' Assign PT values to array
PT_Array = wks.PivotTables(table_Name).DataBodyRange.Value

For j = LBound(PT_Array, 1) To UBound(PT_Array, 1)
    For i = LBound(PT_Array, 2) To UBound(PT_Array, 2)
        If PT_Array(j, i) = 0 Then
       PT_Array(j, i) = ""
        End If
    Next i
Next j

'Locate column in table section that matches first year of data from PT and then set equal to populated array from above
edited_name = Right(edited_name, 6)
results_rng.Find(what:=edited_name).Offset(1, 1).Resize(UBound(PT_Array, 1), UBound(PT_Array, 2)) = PT_Array


'<<<<<<<<<<<<<<<<<<  GZ???X >>>>>>>>>>>>>>>>>>
results_rng.Find(what:="GZ???X").Offset(Month, col_count - 1).Copy
results_rng.Find(what:="GZ???X").Offset(Month, col_count).PasteSpecial Paste:=xlPasteFormulas

'<<<<<<<<<<<<<<<<<<  GZ???X’P‰?  >>>>>>>>>>>>>>>>>>
results_rng.Find(what:="GZ???X’P‰?").Offset(Month, col_count - 1).Copy
results_rng.Find(what:="GZ???X’P‰?").Offset(Month, col_count).PasteSpecial Paste:=xlPasteFormulas

'<<<<<<<<<<<<<<<<<<  ?O?O?|  >>>>>>>>>>>>>>>>>>
results_rng.Find(what:="?O?O?|").Offset(Month, col_count - 1).Copy
results_rng.Find(what:="?O?O?|").Offset(Month, col_count).PasteSpecial Paste:=xlPasteFormulas

'<<<<<<<<<<<<<<<<<<  ?Y?E  >>>>>>>>>>>>>>>>>>
wks.Range("A1").Activate

Set pvt = wks.PivotTables(table_Name)
For Each pf In PT.CalculatedFields
    strSource = pf.SourceName
    strformula = pf.Formula
    pf.Delete
Next pf

target_field = "?Y?E"
edited_name = "?Y?E"

With PT.PivotFields(target_field)
    .Orientation = xlDataField
    .Function = xlSum
    .Position = 1
    '.Caption = edited_name
    .NumberFormat = "#,##"
End With

' Assign PT values to array
PT_Array = wks.PivotTables(table_Name).DataBodyRange.Value

For j = LBound(PT_Array, 1) To UBound(PT_Array, 1)
    For i = LBound(PT_Array, 2) To UBound(PT_Array, 2)
        If PT_Array(j, i) = 0 Then
       PT_Array(j, i) = ""
        End If
    Next i
Next j

'Locate column in table section that matches first year of data from PT and then set equal to populated array from above
edited_name = Right(edited_name, 2)
results_rng.Find(what:=edited_name).Offset(1, 1).Resize(UBound(PT_Array, 1), UBound(PT_Array, 2)) = PT_Array

'<<<<<<<<<<<<<<<<<<    >>>>>>>>>>>>>>>>>>

With ActiveSheet.Cells
    .RowHeight = 12.75
    .Font.Name = "calibri"
    .Cells.Font.Size = 10.5
End With

wks.Range("A1").Activate

    MsgBox "?f?[?^?I?????d?R?1?μ?U?μ???B"
    
End Sub




